<!-- Edit Datatype Form -->
<% local dt = datatype.data or datatype %>
<div class="max-w-4xl mx-auto space-y-6">
  <!-- Header -->
  <div class="flex items-center gap-4">
    <a href="/cruds" class="p-2 hover:bg-white/10 rounded-lg transition-colors">
      <i class="fas fa-arrow-left"></i>
    </a>
    <div>
      <h1 class="text-2xl font-bold text-gradient">Edit <%= dt.name %></h1>
      <p class="text-text-muted mt-1">Modify your data structure</p>
    </div>
  </div>

  <!-- Form -->
  <form hx-put="/cruds/datatypes/<%= dt.slug %>" hx-swap="none" class="space-y-6">
    <!-- Basic Info -->
    <div class="bg-bg-card/50 backdrop-blur-xl border border-border/50 rounded-xl p-6">
      <h2 class="text-lg font-semibold mb-4">Basic Information</h2>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
          <label class="block text-sm font-medium text-text-muted mb-2">Name *</label>
          <input type="text" name="name" required
                 value="<%= dt.name %>"
                 class="w-full px-4 py-2 bg-bg-dark border border-border/50 rounded-lg focus:outline-none focus:border-primary">
        </div>

        <div>
          <label class="block text-sm font-medium text-text-muted mb-2">Slug *</label>
          <input type="text" name="new_slug" required
                 value="<%= dt.slug %>"
                 pattern="^[a-z0-9_-]+$"
                 class="w-full px-4 py-2 bg-bg-dark border border-border/50 rounded-lg focus:outline-none focus:border-primary">
          <p class="text-xs text-text-muted mt-1">URL-safe identifier (lowercase, no spaces)</p>
        </div>

        <div class="md:col-span-2">
          <label class="block text-sm font-medium text-text-muted mb-2">Description</label>
          <textarea name="description" rows="2"
                    class="w-full px-4 py-2 bg-bg-dark border border-border/50 rounded-lg focus:outline-none focus:border-primary resize-none"><%= dt.description or "" %></textarea>
        </div>

        <div class="md:col-span-2">
          <label class="block text-sm font-medium text-text-muted mb-2">Collection Name (optional)</label>
          <input type="text" name="collection_name"
                 value="<%= dt.collection_name or "" %>"
                 placeholder="Leave empty to use 'datasets' collection"
                 class="w-full px-4 py-2 bg-bg-dark border border-border/50 rounded-lg focus:outline-none focus:border-primary">
          <p class="text-xs text-text-muted mt-1">Custom collection name, or leave empty to store in 'datasets' with _type field</p>
        </div>
      </div>
    </div>

    <!-- Fields Builder -->
    <div class="bg-bg-card/50 backdrop-blur-xl border border-border/50 rounded-xl p-6">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-lg font-semibold">Fields</h2>
        <button type="button" onclick="addField()" class="px-3 py-1.5 bg-primary/20 hover:bg-primary/30 text-primary-light rounded-lg transition-colors text-sm">
          <i class="fas fa-plus mr-1"></i> Add Field
        </button>
      </div>

      <div id="fields-container" class="space-y-3">
        <!-- Fields will be populated dynamically -->
      </div>

      <input type="hidden" name="fields" id="fields-json" value="[]">

      <p class="text-xs text-text-muted mt-4">
        <i class="fas fa-info-circle mr-1"></i>
        Drag fields to reorder. Click the gear icon to configure options.
      </p>
    </div>

    <!-- Relations -->
    <div class="bg-bg-card/50 backdrop-blur-xl border border-border/50 rounded-xl p-6">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-lg font-semibold">Relations</h2>
        <button type="button" onclick="addRelation()" class="px-3 py-1.5 bg-primary/20 hover:bg-primary/30 text-primary-light rounded-lg transition-colors text-sm">
          <i class="fas fa-plus mr-1"></i> Add Relation
        </button>
      </div>

      <div id="relations-container" class="space-y-3">
        <!-- Relations will be populated dynamically -->
      </div>

      <input type="hidden" name="relations" id="relations-json" value="[]">

      <p class="text-xs text-text-muted mt-4">
        <i class="fas fa-info-circle mr-1"></i>
        Has-many relations can be embedded (nested array) or referenced (foreign key).
      </p>
    </div>

    <!-- Submit -->
    <div class="flex items-center justify-end gap-3">
      <a href="/cruds" class="px-4 py-2 hover:bg-white/10 rounded-lg transition-colors">Cancel</a>
      <button type="submit" class="px-6 py-2 bg-primary hover:bg-primary-dark text-white rounded-lg transition-colors">
        <i class="fas fa-save mr-2"></i> Save Changes
      </button>
    </div>
  </form>

  <!-- Danger Zone (outside form) -->
  <div class="bg-error/10 border border-error/30 rounded-xl p-6 mt-6">
    <h2 class="text-lg font-semibold text-error mb-4">Danger Zone</h2>
    <div class="flex items-center justify-between">
      <div>
        <p class="font-medium">Delete this datatype</p>
        <p class="text-sm text-text-muted">This action cannot be undone. All associated data can optionally be deleted.</p>
      </div>
      <button type="button" onclick="confirmDelete()" class="px-4 py-2 bg-error hover:bg-error/80 text-white rounded-lg transition-colors">
        <i class="fas fa-trash mr-2"></i> Delete
      </button>
    </div>
  </div>
</div>

<script>
// Field types available
const FIELD_TYPES = <%- EncodeJson(field_types or {"string", "text", "wysiwyg", "gps", "images", "files", "tags", "list", "multilist"}) %>;

// Initialize from existing data
let fields = <%- EncodeJson(dt.fields or {}) %>.map((f, i) => ({...f, id: 'field_' + i}));
let relations = <%- EncodeJson(dt.relations or {}) %>.map((r, i) => ({...r, id: 'relation_' + i}));
let fieldIndex = fields.length;
let relationIndex = relations.length;

// Render existing fields on load and initialize Sortable
document.addEventListener('DOMContentLoaded', function() {
  fields.forEach(field => renderField(field));
  relations.forEach(rel => renderRelation(rel));
  updateFieldsJson();
  updateRelationsJson();

  // Initialize Sortable for drag & drop
  new Sortable(document.getElementById('fields-container'), {
    animation: 150,
    handle: '.fa-grip-vertical',
    ghostClass: 'opacity-50',
    onEnd: function(evt) {
      const newOrder = [];
      document.querySelectorAll('#fields-container > div').forEach(el => {
        const field = fields.find(f => f.id === el.id);
        if (field) newOrder.push(field);
      });
      fields = newOrder;
      updateFieldsJson();
    }
  });

  new Sortable(document.getElementById('relations-container'), {
    animation: 150,
    handle: '.fa-grip-vertical',
    ghostClass: 'opacity-50',
    onEnd: function(evt) {
      const newOrder = [];
      document.querySelectorAll('#relations-container > div').forEach(el => {
        const rel = relations.find(r => r.id === el.id);
        if (rel) newOrder.push(rel);
      });
      relations = newOrder;
      updateRelationsJson();
    }
  });
});

// Render a field element
function renderField(field) {
  const container = document.getElementById('fields-container');

  const fieldHtml = `
    <div id="${field.id}" class="flex items-center gap-3 p-3 bg-bg-dark/50 border border-border/30 rounded-lg group">
      <i class="fas fa-grip-vertical text-text-muted cursor-move"></i>

      <input type="text" placeholder="Field name" data-field="name" value="${field.name || ''}"
             class="flex-1 px-3 py-1.5 bg-bg-dark border border-border/50 rounded focus:outline-none focus:border-primary text-sm"
             onchange="updateFieldData('${field.id}')">

      <select data-field="type" onchange="updateFieldData('${field.id}')"
              class="px-3 py-1.5 bg-bg-dark border border-border/50 rounded focus:outline-none focus:border-primary text-sm">
        ${FIELD_TYPES.map(t => `<option value="${t}" ${t === field.type ? 'selected' : ''}>${t}</option>`).join('')}
      </select>

      <input type="text" placeholder="Label" data-field="label" value="${field.label || ''}"
             class="w-32 px-3 py-1.5 bg-bg-dark border border-border/50 rounded focus:outline-none focus:border-primary text-sm"
             onchange="updateFieldData('${field.id}')">

      <label class="flex items-center gap-1 text-sm">
        <input type="checkbox" data-field="required" ${field.required ? 'checked' : ''} onchange="updateFieldData('${field.id}')" class="rounded">
        <span class="text-text-muted">Required</span>
      </label>

      <button type="button" onclick="configureField('${field.id}')" class="p-1.5 hover:bg-white/10 rounded transition-colors opacity-0 group-hover:opacity-100" title="Configure">
        <i class="fas fa-cog text-text-muted"></i>
      </button>

      <button type="button" onclick="removeField('${field.id}')" class="p-1.5 hover:bg-error/20 rounded transition-colors opacity-0 group-hover:opacity-100" title="Remove">
        <i class="fas fa-times text-error"></i>
      </button>
    </div>
  `;

  container.insertAdjacentHTML('beforeend', fieldHtml);
}

// Render a relation element
function renderRelation(rel) {
  const container = document.getElementById('relations-container');

  const relationHtml = `
    <div id="${rel.id}" class="flex items-center gap-3 p-3 bg-bg-dark/50 border border-border/30 rounded-lg group">
      <i class="fas fa-grip-vertical text-text-muted cursor-move"></i>

      <input type="text" placeholder="Relation name" data-relation="name" value="${rel.name || ''}"
             class="flex-1 px-3 py-1.5 bg-bg-dark border border-border/50 rounded focus:outline-none focus:border-primary text-sm"
             onchange="updateRelationData('${rel.id}')">

      <input type="text" placeholder="Target datatype slug" data-relation="target_datatype" value="${rel.target_datatype || ''}"
             class="flex-1 px-3 py-1.5 bg-bg-dark border border-border/50 rounded focus:outline-none focus:border-primary text-sm"
             onchange="updateRelationData('${rel.id}')">

      <select data-relation="storage" onchange="updateRelationData('${rel.id}')"
              class="px-3 py-1.5 bg-bg-dark border border-border/50 rounded focus:outline-none focus:border-primary text-sm">
        <option value="embedded" ${rel.storage === 'embedded' ? 'selected' : ''}>Embedded</option>
        <option value="referenced" ${rel.storage === 'referenced' ? 'selected' : ''}>Referenced</option>
      </select>

      <button type="button" onclick="removeRelation('${rel.id}')" class="p-1.5 hover:bg-error/20 rounded transition-colors opacity-0 group-hover:opacity-100" title="Remove">
        <i class="fas fa-times text-error"></i>
      </button>
    </div>
  `;

  container.insertAdjacentHTML('beforeend', relationHtml);
}

// Add a new field
function addField() {
  const id = 'field_' + fieldIndex++;
  const field = {
    id: id,
    name: '',
    type: 'string',
    label: '',
    required: false,
    placeholder: '',
    options: []
  };
  fields.push(field);
  renderField(field);
  updateFieldsJson();
}

// Update field data from inputs
function updateFieldData(id) {
  const el = document.getElementById(id);
  const field = fields.find(f => f.id === id);
  if (!field) return;

  field.name = el.querySelector('[data-field="name"]').value;
  field.type = el.querySelector('[data-field="type"]').value;
  field.label = el.querySelector('[data-field="label"]').value;
  field.required = el.querySelector('[data-field="required"]').checked;

  updateFieldsJson();
}

// Remove a field
function removeField(id) {
  document.getElementById(id).remove();
  fields = fields.filter(f => f.id !== id);
  updateFieldsJson();
}

// Configure field options (modal)
function configureField(id) {
  const field = fields.find(f => f.id === id);
  if (!field) return;

  let optionsHtml = '';
  if (field.type === 'list' || field.type === 'multilist') {
    optionsHtml = `
      <div class="mt-4">
        ${field.type === 'list' ? `
        <div class="mb-4 p-3 bg-bg-dark/50 rounded-lg">
          <label class="flex items-center gap-2 cursor-pointer">
            <input type="checkbox" id="field-allow-blank" ${field.allow_blank !== false ? 'checked' : ''} class="rounded">
            <span class="text-sm">Allow blank value</span>
          </label>
          <p class="text-xs text-text-muted mt-1 ml-6">When unchecked, user must select a value</p>
        </div>
        ` : ''}
        <label class="block text-sm font-medium text-text-muted mb-2">Options Source</label>
        <div class="flex gap-2 mb-3">
          <button type="button" onclick="toggleOptionsSource('static')" id="btn-static"
                  class="px-3 py-1.5 rounded-lg text-sm transition-colors ${field.source_query ? 'bg-white/5 text-text-muted' : 'bg-primary/20 text-primary-light'}">
            Static List
          </button>
          <button type="button" onclick="toggleOptionsSource('query')" id="btn-query"
                  class="px-3 py-1.5 rounded-lg text-sm transition-colors ${field.source_query ? 'bg-primary/20 text-primary-light' : 'bg-white/5 text-text-muted'}">
            SDBQL Query
          </button>
        </div>
        <div id="static-options" class="${field.source_query ? 'hidden' : ''}">
          <label class="block text-sm font-medium text-text-muted mb-2">Options (one per line)</label>
          <textarea id="field-options" rows="4" class="w-full px-4 py-2 bg-bg-dark border border-border/50 rounded-lg focus:outline-none focus:border-primary font-mono text-sm">${(field.options || []).join('\\n')}</textarea>
        </div>
        <div id="query-options" class="${field.source_query ? '' : 'hidden'}">
          <label class="block text-sm font-medium text-text-muted mb-2">SDBQL Query</label>
          <textarea id="field-source-query" rows="4" placeholder="FOR doc IN collection RETURN doc.name"
                    class="w-full px-4 py-2 bg-bg-dark border border-border/50 rounded-lg focus:outline-none focus:border-primary font-mono text-sm">${field.source_query || ''}</textarea>
          <p class="text-xs text-text-muted mt-2">
            <i class="fas fa-info-circle mr-1"></i>
            Use <code class="px-1 py-0.5 bg-white/10 rounded">@doc</code> to reference the current document's _id
          </p>
          <div class="mt-3">
            <label class="block text-sm font-medium text-text-muted mb-2">Label Field (optional)</label>
            <input type="text" id="field-label-field" value="${field.label_field || ''}" placeholder="e.g., name or title"
                   class="w-full px-4 py-2 bg-bg-dark border border-border/50 rounded-lg focus:outline-none focus:border-primary text-sm">
            <p class="text-xs text-text-muted mt-1">Field to display as label (if query returns objects)</p>
          </div>
          <div class="mt-3">
            <label class="block text-sm font-medium text-text-muted mb-2">Value Field (optional)</label>
            <input type="text" id="field-value-field" value="${field.value_field || ''}" placeholder="e.g., _key or _id"
                   class="w-full px-4 py-2 bg-bg-dark border border-border/50 rounded-lg focus:outline-none focus:border-primary text-sm">
            <p class="text-xs text-text-muted mt-1">Field to use as value (if query returns objects)</p>
          </div>
        </div>
      </div>
    `;
  }

  const modalHtml = `
    <div class="fixed inset-0 z-[300] bg-black/60 backdrop-blur-sm flex items-center justify-center p-4" onclick="if(event.target===this) closeModal()">
      <div class="bg-bg-card border border-border/50 rounded-xl p-6 w-full max-w-lg max-h-[90vh] overflow-y-auto">
        <h3 class="text-lg font-semibold mb-4">Configure Field: ${field.name || 'Unnamed'}</h3>

        <div>
          <label class="block text-sm font-medium text-text-muted mb-2">Placeholder</label>
          <input type="text" id="field-placeholder" value="${field.placeholder || ''}"
                 class="w-full px-4 py-2 bg-bg-dark border border-border/50 rounded-lg focus:outline-none focus:border-primary">
        </div>

        ${optionsHtml}

        <div class="flex justify-end gap-3 mt-6">
          <button type="button" onclick="closeModal()" class="px-4 py-2 hover:bg-white/10 rounded-lg transition-colors">Cancel</button>
          <button type="button" onclick="saveFieldConfig('${id}')" class="px-4 py-2 bg-primary hover:bg-primary-dark text-white rounded-lg transition-colors">Save</button>
        </div>
      </div>
    </div>
  `;

  document.getElementById('modal-container').innerHTML = modalHtml;
}

// Toggle between static options and query source
function toggleOptionsSource(type) {
  const staticDiv = document.getElementById('static-options');
  const queryDiv = document.getElementById('query-options');
  const btnStatic = document.getElementById('btn-static');
  const btnQuery = document.getElementById('btn-query');

  if (type === 'static') {
    staticDiv.classList.remove('hidden');
    queryDiv.classList.add('hidden');
    btnStatic.classList.remove('bg-white/5', 'text-text-muted');
    btnStatic.classList.add('bg-primary/20', 'text-primary-light');
    btnQuery.classList.remove('bg-primary/20', 'text-primary-light');
    btnQuery.classList.add('bg-white/5', 'text-text-muted');
  } else {
    staticDiv.classList.add('hidden');
    queryDiv.classList.remove('hidden');
    btnQuery.classList.remove('bg-white/5', 'text-text-muted');
    btnQuery.classList.add('bg-primary/20', 'text-primary-light');
    btnStatic.classList.remove('bg-primary/20', 'text-primary-light');
    btnStatic.classList.add('bg-white/5', 'text-text-muted');
  }
}

// Save field configuration
function saveFieldConfig(id) {
  const field = fields.find(f => f.id === id);
  if (!field) return;

  field.placeholder = document.getElementById('field-placeholder').value;

  const optionsEl = document.getElementById('field-options');
  if (optionsEl) {
    field.options = optionsEl.value.split('\\n').map(o => o.trim()).filter(o => o);
  }

  const sourceQueryEl = document.getElementById('field-source-query');
  if (sourceQueryEl) {
    field.source_query = sourceQueryEl.value.trim() || null;
    field.label_field = document.getElementById('field-label-field')?.value.trim() || null;
    field.value_field = document.getElementById('field-value-field')?.value.trim() || null;
  }

  const allowBlankEl = document.getElementById('field-allow-blank');
  if (allowBlankEl) {
    field.allow_blank = allowBlankEl.checked;
  }

  updateFieldsJson();
  closeModal();
}

// Add a new relation
function addRelation() {
  const id = 'relation_' + relationIndex++;
  const rel = {
    id: id,
    name: '',
    target_datatype: '',
    storage: 'embedded'
  };
  relations.push(rel);
  renderRelation(rel);
  updateRelationsJson();
}

// Update relation data from inputs
function updateRelationData(id) {
  const el = document.getElementById(id);
  const rel = relations.find(r => r.id === id);
  if (!rel) return;

  rel.name = el.querySelector('[data-relation="name"]').value;
  rel.target_datatype = el.querySelector('[data-relation="target_datatype"]').value;
  rel.storage = el.querySelector('[data-relation="storage"]').value;

  updateRelationsJson();
}

// Remove a relation
function removeRelation(id) {
  document.getElementById(id).remove();
  relations = relations.filter(r => r.id !== id);
  updateRelationsJson();
}

// Update hidden JSON inputs
function updateFieldsJson() {
  const cleanFields = fields.map(f => ({
    name: f.name,
    type: f.type,
    label: f.label,
    required: f.required,
    placeholder: f.placeholder,
    options: f.options
  })).filter(f => f.name);

  document.getElementById('fields-json').value = JSON.stringify(cleanFields);
}

function updateRelationsJson() {
  const cleanRelations = relations.map(r => ({
    name: r.name,
    target_datatype: r.target_datatype,
    storage: r.storage
  })).filter(r => r.name && r.target_datatype);

  document.getElementById('relations-json').value = JSON.stringify(cleanRelations);
}

// Confirm delete
function confirmDelete() {
  const modalHtml = `
    <div class="fixed inset-0 z-[300] bg-black/60 backdrop-blur-sm flex items-center justify-center p-4" onclick="if(event.target===this) closeModal()">
      <div class="bg-bg-card border border-error/30 rounded-xl p-6 w-full max-w-md">
        <h3 class="text-lg font-semibold text-error mb-4">Delete Datatype</h3>
        <p class="text-text-muted mb-4">Are you sure you want to delete "<%= dt.name %>"? This action cannot be undone.</p>

        <label class="flex items-center gap-2 mb-4">
          <input type="checkbox" id="delete-data-checkbox" class="rounded">
          <span class="text-sm">Also delete all associated data records</span>
        </label>

        <div class="flex justify-end gap-3">
          <button type="button" onclick="closeModal()" class="px-4 py-2 hover:bg-white/10 rounded-lg transition-colors">Cancel</button>
          <button type="button" onclick="executeDelete()" class="px-4 py-2 bg-error hover:bg-error/80 text-white rounded-lg transition-colors">Delete</button>
        </div>
      </div>
    </div>
  `;

  document.getElementById('modal-container').innerHTML = modalHtml;
}

function executeDelete() {
  const deleteData = document.getElementById('delete-data-checkbox').checked;
  const url = '/cruds/datatypes/<%= dt.slug %>' + (deleteData ? '?delete_data=true' : '');

  htmx.ajax('DELETE', url, {target: 'body', swap: 'none'});
  closeModal();
}
</script>
