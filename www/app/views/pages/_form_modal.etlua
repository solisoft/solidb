<div class="fixed inset-0 z-[100] flex items-center justify-center p-4 sm:p-6" role="dialog" aria-modal="true">
  <!-- Backdrop -->
  <div class="absolute inset-0 bg-black/60 backdrop-blur-sm transition-opacity" onclick="document.getElementById('modal-container').innerHTML = ''"></div>

  <!-- Modal Panel -->
  <div class="relative bg-bg-card border border-white/10 rounded-2xl shadow-2xl w-full max-w-md overflow-hidden transform transition-all">
    <div class="p-6">
      <div class="flex items-center justify-between mb-6">
        <h3 class="text-lg font-bold text-white"><%= page and "Edit Page" or "New Page" %></h3>
        <button class="text-text-muted hover:text-white transition-colors" onclick="document.getElementById('modal-container').innerHTML = ''">
          <i class="fas fa-times"></i>
        </button>
      </div>

      <form <% if page then %>
              hx-put="/pages/<%= page._key %>"
            <% else %>
              hx-post="/pages"
            <% end %>
            hx-target="#main-content"
            hx-select="#main-content"
            hx-swap="outerHTML">

        <% if not page and parent_id and parent_id ~= "" then %>
          <input type="hidden" name="parent_id" value="<%= parent_id %>">
          <div class="text-xs text-text-muted mb-2"><i class="fas fa-level-up-alt fa-rotate-90 mr-1"></i>Creating as child page</div>
        <% end %>

        <div class="space-y-4">
          <% if page then %>
          <!-- Parent Selection (only for existing pages) -->
          <div>
            <label class="block text-xs font-semibold text-text-dim uppercase tracking-wider mb-2">Parent Page</label>
            <select name="parent_id" class="w-full bg-white/5 border border-white/10 rounded-lg px-3 py-2 text-white focus:outline-none focus:border-primary focus:ring-1 focus:ring-primary transition-all shadow-sm">
              <option value="" <%= (not page.parent_id or page.parent_id == "") and 'selected' or '' %>>None (Root level)</option>
              <% for _, p in ipairs(all_pages or {}) do %>
                <% if p._key ~= page._key then %>
                  <option value="<%= p._key %>" <%= page.parent_id == p._key and 'selected' or '' %>><%= p.icon or "ðŸ“„" %> <%= p.title %></option>
                <% end %>
              <% end %>
            </select>
          </div>
          <% end %>
          <!-- Icon with Emoji Picker -->
          <div>
            <label class="block text-xs font-semibold text-text-dim uppercase tracking-wider mb-2">Icon</label>
            <div class="flex gap-2 relative">
               <input type="text" name="icon" id="icon-input" value="<%= page and page.icon or 'ðŸ“„' %>" readonly
                      onclick="toggleEmojiPicker()"
                      class="w-12 text-center text-xl bg-white/5 border border-white/10 rounded-lg px-3 py-2 text-white focus:outline-none focus:border-primary focus:ring-1 focus:ring-primary transition-all shadow-sm cursor-pointer hover:bg-white/10">
               <div class="text-xs text-text-muted self-center">Click to pick emoji</div>

               <!-- Emoji Picker Popup -->
               <div id="emoji-picker" class="hidden absolute top-full left-0 mt-2 w-72 bg-bg-card border border-white/10 rounded-xl shadow-2xl z-50 overflow-hidden">
                 <!-- Category Tabs -->
                 <div class="flex border-b border-white/10 px-2 pt-2 gap-1 overflow-x-auto" id="emoji-tabs">
                   <button type="button" onclick="showEmojiCategory('pages')" data-cat="pages" class="emoji-tab px-2 py-1 rounded-lg text-sm whitespace-nowrap transition-colors bg-primary text-white">Pages</button>
                   <button type="button" onclick="showEmojiCategory('objects')" data-cat="objects" class="emoji-tab px-2 py-1 rounded-lg text-sm whitespace-nowrap transition-colors text-text-muted hover:bg-white/10">Objects</button>
                   <button type="button" onclick="showEmojiCategory('symbols')" data-cat="symbols" class="emoji-tab px-2 py-1 rounded-lg text-sm whitespace-nowrap transition-colors text-text-muted hover:bg-white/10">Symbols</button>
                   <button type="button" onclick="showEmojiCategory('nature')" data-cat="nature" class="emoji-tab px-2 py-1 rounded-lg text-sm whitespace-nowrap transition-colors text-text-muted hover:bg-white/10">Nature</button>
                   <button type="button" onclick="showEmojiCategory('tech')" data-cat="tech" class="emoji-tab px-2 py-1 rounded-lg text-sm whitespace-nowrap transition-colors text-text-muted hover:bg-white/10">Tech</button>
                   <button type="button" onclick="showEmojiCategory('faces')" data-cat="faces" class="emoji-tab px-2 py-1 rounded-lg text-sm whitespace-nowrap transition-colors text-text-muted hover:bg-white/10">Faces</button>
                 </div>
                 <!-- Emoji Grids -->
                 <div class="p-3 max-h-48 overflow-y-auto">
                   <div id="emoji-grid-pages" class="emoji-grid grid grid-cols-8 gap-1">
                     <% for _, e in ipairs({'ðŸ“„', 'ðŸ“', 'ðŸ“‹', 'ðŸ“Œ', 'ðŸ“Ž', 'ðŸ“', 'ðŸ“‚', 'ðŸ—‚ï¸', 'ðŸ“°', 'ðŸ“‘', 'ðŸ—’ï¸', 'ðŸ““', 'ðŸ“”', 'ðŸ“•', 'ðŸ“–', 'ðŸ“š'}) do %>
                       <button type="button" onclick="selectEmoji('<%= e %>')" class="w-8 h-8 flex items-center justify-center text-xl rounded hover:bg-white/10 transition-colors"><%= e %></button>
                     <% end %>
                   </div>
                   <div id="emoji-grid-objects" class="emoji-grid grid grid-cols-8 gap-1 hidden">
                     <% for _, e in ipairs({'ðŸ’¡', 'ðŸ”§', 'âš™ï¸', 'ðŸ”¨', 'ðŸ› ï¸', 'ðŸ“¦', 'ðŸŽ', 'ðŸ·ï¸', 'ðŸ”‘', 'ðŸ”’', 'ðŸ’Ž', 'ðŸ§²', 'ðŸ”®', 'ðŸŽ¯', 'ðŸ§©', 'ðŸŽ²'}) do %>
                       <button type="button" onclick="selectEmoji('<%= e %>')" class="w-8 h-8 flex items-center justify-center text-xl rounded hover:bg-white/10 transition-colors"><%= e %></button>
                     <% end %>
                   </div>
                   <div id="emoji-grid-symbols" class="emoji-grid grid grid-cols-8 gap-1 hidden">
                     <% for _, e in ipairs({'â­', 'âœ¨', 'ðŸ’«', 'ðŸŒŸ', 'âš¡', 'ðŸ”¥', 'â¤ï¸', 'ðŸ’š', 'ðŸ’™', 'ðŸ’œ', 'ðŸ§¡', 'ðŸ’›', 'âœ…', 'âŒ', 'âš ï¸', 'ðŸ’¬'}) do %>
                       <button type="button" onclick="selectEmoji('<%= e %>')" class="w-8 h-8 flex items-center justify-center text-xl rounded hover:bg-white/10 transition-colors"><%= e %></button>
                     <% end %>
                   </div>
                   <div id="emoji-grid-nature" class="emoji-grid grid grid-cols-8 gap-1 hidden">
                     <% for _, e in ipairs({'ðŸŒ±', 'ðŸŒ¿', 'ðŸ€', 'ðŸŒ¸', 'ðŸŒº', 'ðŸŒ»', 'ðŸŒ²', 'ðŸŒ³', 'ðŸ', 'ðŸŒŠ', 'â˜€ï¸', 'ðŸŒ™', 'â›…', 'ðŸŒˆ', 'ðŸ¦‹', 'ðŸ'}) do %>
                       <button type="button" onclick="selectEmoji('<%= e %>')" class="w-8 h-8 flex items-center justify-center text-xl rounded hover:bg-white/10 transition-colors"><%= e %></button>
                     <% end %>
                   </div>
                   <div id="emoji-grid-tech" class="emoji-grid grid grid-cols-8 gap-1 hidden">
                     <% for _, e in ipairs({'ðŸ’»', 'ðŸ–¥ï¸', 'ðŸ“±', 'âŒ¨ï¸', 'ðŸ–±ï¸', 'ðŸ’¾', 'ðŸ“€', 'ðŸ”Œ', 'ðŸ”‹', 'ðŸ“¡', 'ðŸ›°ï¸', 'ðŸ¤–', 'ðŸ§ ', 'ðŸ“Š', 'ðŸ“ˆ', 'ðŸ”¬'}) do %>
                       <button type="button" onclick="selectEmoji('<%= e %>')" class="w-8 h-8 flex items-center justify-center text-xl rounded hover:bg-white/10 transition-colors"><%= e %></button>
                     <% end %>
                   </div>
                   <div id="emoji-grid-faces" class="emoji-grid grid grid-cols-8 gap-1 hidden">
                     <% for _, e in ipairs({'ðŸ˜€', 'ðŸ˜Š', 'ðŸ¤”', 'ðŸ˜Ž', 'ðŸ¤“', 'ðŸ§', 'ðŸ˜‡', 'ðŸ¥³', 'ðŸ˜', 'ðŸ¤©', 'ðŸ˜´', 'ðŸ¤¯', 'ðŸ‘', 'ðŸ‘', 'ðŸ™Œ', 'ðŸŽ‰'}) do %>
                       <button type="button" onclick="selectEmoji('<%= e %>')" class="w-8 h-8 flex items-center justify-center text-xl rounded hover:bg-white/10 transition-colors"><%= e %></button>
                     <% end %>
                   </div>
                 </div>
               </div>
            </div>
          </div>

          <!-- Title -->
          <div>
            <label class="block text-xs font-semibold text-text-dim uppercase tracking-wider mb-2">Title</label>
            <input type="text" name="title" value="<%= (page and page.title) or '' %>" placeholder="Page Title" required autofocus
                   class="w-full bg-white/5 border border-white/10 rounded-lg px-3 py-2 text-white placeholder-text-muted/50 focus:outline-none focus:border-primary focus:ring-1 focus:ring-primary transition-all shadow-sm">
          </div>

          <!-- Cover Image -->
          <div>
            <label class="block text-xs font-semibold text-text-dim uppercase tracking-wider mb-2">Cover Image</label>
            <input type="hidden" name="cover" id="cover-input" value="<%= (page and page.cover) or '' %>">

            <!-- Drop Zone (shown when no image) -->
            <div id="cover-dropzone" class="<%= (page and page.cover and page.cover ~= '') and 'hidden' or '' %> relative cursor-pointer"
                 onclick="document.getElementById('cover-file-input').click()">
              <div class="h-24 border-2 border-dashed border-white/20 rounded-lg flex flex-col items-center justify-center gap-2 transition-all hover:border-primary hover:bg-primary/5">
                <i class="fas fa-cloud-upload-alt text-2xl text-text-muted"></i>
                <p class="text-xs text-text-muted">Drop image here or <span class="text-primary">browse</span></p>
              </div>
              <div id="cover-spinner" class="hidden absolute inset-0 bg-black/50 rounded-lg flex items-center justify-center">
                <i class="fas fa-spinner fa-spin text-2xl text-primary"></i>
              </div>
              <input type="file" id="cover-file-input" accept="image/*" class="hidden" onchange="handleCoverFileSelect(event)">
            </div>

            <!-- Preview (shown when image exists) -->
            <div id="cover-preview" class="<%= (page and page.cover and page.cover ~= '') and '' or 'hidden' %> h-24 rounded-lg overflow-hidden border border-white/10 relative group">
              <img id="cover-preview-img" src="<%= (page and page.cover) or '' %>" class="w-full h-full object-cover">
              <div class="absolute inset-0 bg-black/50 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center gap-3">
                <button type="button" onclick="document.getElementById('cover-file-input').click()" class="w-8 h-8 rounded-full bg-white/20 text-white flex items-center justify-center hover:bg-primary transition-colors">
                  <i class="fas fa-sync-alt text-xs"></i>
                </button>
                <button type="button" onclick="clearCover()" class="w-8 h-8 rounded-full bg-white/20 text-white flex items-center justify-center hover:bg-red-500 transition-colors">
                  <i class="fas fa-trash text-xs"></i>
                </button>
              </div>
            </div>
          </div>

        </div>

        <div class="mt-8 flex justify-end gap-3">
          <button type="button" class="px-4 py-2 rounded-lg text-text-dim hover:text-white hover:bg-white/5 transition-colors" onclick="document.getElementById('modal-container').innerHTML = ''">Cancel</button>
          <button type="submit" class="px-6 py-2 rounded-lg bg-primary hover:bg-primary-hover text-white font-medium shadow-lg shadow-primary/20 transition-all">
            <%= page and "Save Changes" or "Create Page" %>
          </button>
        </div>
      </form>
    </div>
  </div>

  <script>
    // Emoji Picker
    function toggleEmojiPicker() {
      document.getElementById('emoji-picker').classList.toggle('hidden');
    }

    function showEmojiCategory(cat) {
      document.querySelectorAll('.emoji-grid').forEach(g => g.classList.add('hidden'));
      document.getElementById('emoji-grid-' + cat).classList.remove('hidden');
      document.querySelectorAll('.emoji-tab').forEach(t => {
        t.classList.remove('bg-primary', 'text-white');
        t.classList.add('text-text-muted');
      });
      document.querySelector('.emoji-tab[data-cat="' + cat + '"]').classList.add('bg-primary', 'text-white');
      document.querySelector('.emoji-tab[data-cat="' + cat + '"]').classList.remove('text-text-muted');
    }

    function selectEmoji(emoji) {
      document.getElementById('icon-input').value = emoji;
      document.getElementById('emoji-picker').classList.add('hidden');
    }

    // Close emoji picker when clicking outside
    document.addEventListener('click', function(e) {
      const picker = document.getElementById('emoji-picker');
      const iconInput = document.getElementById('icon-input');
      if (picker && !picker.contains(e.target) && e.target !== iconInput) {
        picker.classList.add('hidden');
      }
    });

    // Cover Image
    function clearCover() {
      document.getElementById('cover-input').value = '';
      document.getElementById('cover-preview').classList.add('hidden');
      document.getElementById('cover-dropzone').classList.remove('hidden');
    }

    function showCoverPreview(url) {
      document.getElementById('cover-input').value = url;
      document.getElementById('cover-preview-img').src = url;
      document.getElementById('cover-preview').classList.remove('hidden');
      document.getElementById('cover-dropzone').classList.add('hidden');
    }

    async function uploadCoverImage(file) {
      if (!file || !file.type.startsWith('image/')) return;

      const spinner = document.getElementById('cover-spinner');
      spinner.classList.remove('hidden');

      const formData = new FormData();
      formData.append('file', file);

      try {
        const resp = await fetch('/pages/upload_cover', { method: 'POST', body: formData });
        const data = await resp.json();
        if (data.url) {
          showCoverPreview(data.url);
        }
      } catch (err) {
        console.error(err);
      }

      spinner.classList.add('hidden');
    }

    function handleCoverFileSelect(e) {
      const file = e.target.files[0];
      if (file) uploadCoverImage(file);
    }

    // Drag and drop for cover
    const dropzone = document.getElementById('cover-dropzone');
    if (dropzone) {
      const dropzoneInner = dropzone.querySelector('div');

      dropzone.addEventListener('dragover', function(e) {
        e.preventDefault();
        dropzoneInner.classList.add('border-primary', 'bg-primary/10');
      });

      dropzone.addEventListener('dragleave', function(e) {
        e.preventDefault();
        dropzoneInner.classList.remove('border-primary', 'bg-primary/10');
      });

      dropzone.addEventListener('drop', function(e) {
        e.preventDefault();
        dropzoneInner.classList.remove('border-primary', 'bg-primary/10');
        const file = e.dataTransfer.files[0];
        if (file) uploadCoverImage(file);
      });
    }
  </script>
</div>
