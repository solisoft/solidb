<!DOCTYPE html>
<html lang="en" style="scroll-behavior: smooth">
  <head>
    <meta charset="UTF-8" />
    <title><%= title or "SoliDB - High Performance Rust Database" %></title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta
      name="description"
      content="SoliDB - A New High Performance Database Server"
    />
    <meta property="og:image" content="/images/logo.jpg" />
    <link rel="stylesheet" href="<%= PublicPath("/app.css") %>" />
    <link rel="icon" type="image/svg+xml" href="<%= PublicPath("/logo.svg") %>" />
    <link rel="manifest" href="/manifest.json" />
    <script src="<%= PublicPath("/app/components/talks-common.js") %>"></script>
    <script>
      // Unregister Service Workers to clear stale cache
      if ('serviceWorker' in navigator) {
        navigator.serviceWorker.getRegistrations().then(function(registrations) {
          for(let registration of registrations) {
            registration.unregister();
          }
        });

        // Clear caches
        if ('caches' in window) {
           caches.keys().then(function(names) {
             for (let name of names) {
               caches.delete(name);
             }
           });
        }
      }
    </script>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.9.0/build/styles/atom-one-dark.min.css"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
      integrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    />
    <link
      href="https://fonts.googleapis.com/icon?family=Material+Icons+Outlined"
      rel="stylesheet"
    />
    <script src="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.9.0/build/highlight.min.js"></script>
    <script src="https://unpkg.com/@msgpack/msgpack@3.0.0/dist/msgpack.min.js"></script>
    <script src="<%= PublicPath('/app_vendor.js') %>"></script>
  </head>

  <body
    class="h-screen flex flex-col bg-gray-900 font-sans text-gray-100 overflow-hidden"
  >
    <!-- Global Background Decorations -->
    <div
      class="fixed top-0 left-0 w-full h-full overflow-hidden z-0 pointer-events-none"
    >
      <div
        class="absolute top-[-10%] left-[-10%] w-1/2 h-1/2 bg-indigo-900/20 rounded-full blur-[120px]"
      ></div>
      <div
        class="absolute bottom-[-10%] right-[-10%] w-1/2 h-1/2 bg-purple-900/20 rounded-full blur-[120px]"
      ></div>
    </div>

    <!-- Header (Fixed Top) -->
    <% if not Params.hide_header then %>
    <div class="relative z-0 flex-shrink-0"><%- Partial("header") %></div>
    <% end %>

    <!-- Flex Container for Sidebar + Main Content -->
    <div class="flex flex-1 overflow-hidden relative z-10">
      <!-- Sidebar (Only shown if db param exists) -->
      <% if Params['db'] then %>
      <aside
        class="w-64 bg-gray-900/50 backdrop-blur-xl border-r border-gray-800 overflow-y-auto hidden md:block flex-shrink-0"
      >
        <%- Partial("side_nav") %>
      </aside>
      <% end %>

      <!-- Main Scrollable Content -->
      <main
        class="flex-1 <%= Params.full_height and 'overflow-hidden' or 'overflow-y-auto' %> bg-transparent"
      >
        <div class="h-full flex flex-col">
          <div
            class="flex-1 <%= (Params.full_height or Params.no_padding) and 'p-0 min-h-0' or 'p-4 sm:p-6 lg:p-8' %>"
          >
            @yield
          </div>
          <% if not Params.full_height then %>
          <div class="mt-auto"><%- Partial("footer") %></div>
          <% end %>
        </div>
      </main>
    </div>

    <%- RefreshPageForDevMode() %>

    <script type="module">
      import {
        getServerConfig,
        getAuthToken,
        clearAuthToken,
      } from '<%= PublicPath("/api-config.js") %>';

      document.addEventListener("DOMContentLoaded", (event) => {
        document.querySelectorAll("pre code").forEach((el) => {
          hljs.highlightElement(el);
        });

        // Logout button handler
        const logoutBtn = document.getElementById("logout-btn");
        if (logoutBtn) {
          logoutBtn.addEventListener("click", () => {
            localStorage.removeItem("solidb_auth_token");
            localStorage.removeItem("solidb_server_config");
            window.location.href = "/";
          });
        }

        // Change password modal
        const changePasswordBtn = document.getElementById(
          "change-password-btn"
        );
        const modal = document.getElementById("change-password-modal");
        const form = document.getElementById("change-password-form");
        const errorDiv = document.getElementById("password-error");
        const successDiv = document.getElementById("password-success");
        const closeBtn = document.getElementById("close-password-modal");
        const cancelBtn = document.getElementById("cancel-password-btn");

        if (changePasswordBtn && modal) {
          changePasswordBtn.addEventListener("click", () => {
            modal.classList.remove("hidden");
            errorDiv.classList.add("hidden");
            successDiv.classList.add("hidden");
            form.reset();
          });

          const closeModal = () => modal.classList.add("hidden");
          closeBtn?.addEventListener("click", closeModal);
          cancelBtn?.addEventListener("click", closeModal);
          modal.addEventListener("click", (e) => {
            if (e.target === modal) closeModal();
          });

          form?.addEventListener("submit", async (e) => {
            e.preventDefault();
            errorDiv.classList.add("hidden");
            successDiv.classList.add("hidden");

            const currentPassword =
              document.getElementById("current-password").value;
            const newPassword = document.getElementById("new-password").value;
            const confirmPassword =
              document.getElementById("confirm-password").value;

            if (newPassword !== confirmPassword) {
              errorDiv.textContent = "New passwords do not match";
              errorDiv.classList.remove("hidden");
              return;
            }

            try {
              const config = getServerConfig();
              const token = getAuthToken();
              const response = await fetch(
                `${config.host}:${config.port}/_api/auth/password`,
                {
                  method: "PUT",
                  headers: {
                    "Content-Type": "application/json",
                    Authorization: `Bearer ${token}`,
                  },
                  body: JSON.stringify({
                    current_password: currentPassword,
                    new_password: newPassword,
                  }),
                }
              );

              if (response.ok) {
                successDiv.textContent = "Password updated successfully!";
                successDiv.classList.remove("hidden");
                form.reset();
                setTimeout(closeModal, 2000);
              } else {
                const error = await response.json().catch(() => ({}));
                errorDiv.textContent =
                  error.error || "Failed to update password";
                errorDiv.classList.remove("hidden");
              }
            } catch (error) {
              errorDiv.textContent = "Connection error";
              errorDiv.classList.remove("hidden");
            }
          });
        }
      });
    </script>

    <!-- Change Password Modal -->
    <div
      id="change-password-modal"
      class="hidden fixed inset-0 z-50 overflow-y-auto"
    >
      <div class="flex items-center justify-center min-h-screen px-4">
        <div class="fixed inset-0 bg-black/50 backdrop-blur-sm"></div>
        <div
          class="relative bg-gray-800 rounded-2xl shadow-2xl border border-gray-700 max-w-md w-full p-6"
        >
          <div class="flex justify-between items-center mb-4">
            <h3 class="text-lg font-semibold text-white">Change Password</h3>
            <button
              id="close-password-modal"
              class="text-gray-400 hover:text-white"
            >
              <svg
                class="h-5 w-5"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M6 18L18 6M6 6l12 12"
                />
              </svg>
            </button>
          </div>

          <div
            id="password-error"
            class="hidden mb-4 px-4 py-2 bg-red-500/10 border border-red-500/30 text-red-400 rounded-lg text-sm"
          ></div>
          <div
            id="password-success"
            class="hidden mb-4 px-4 py-2 bg-green-500/10 border border-green-500/30 text-green-400 rounded-lg text-sm"
          ></div>

          <form id="change-password-form" class="space-y-4">
            <div>
              <label class="block text-sm font-medium text-gray-300 mb-1"
                >Current Password</label
              >
              <input
                type="password"
                id="current-password"
                required
                class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white focus:ring-2 focus:ring-indigo-500"
              />
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-300 mb-1"
                >New Password</label
              >
              <input
                type="password"
                id="new-password"
                required
                class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white focus:ring-2 focus:ring-indigo-500"
              />
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-300 mb-1"
                >Confirm New Password</label
              >
              <input
                type="password"
                id="confirm-password"
                required
                class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white focus:ring-2 focus:ring-indigo-500"
              />
            </div>
            <div class="flex justify-end gap-3 pt-2">
              <button
                type="button"
                id="cancel-password-btn"
                class="px-4 py-2 text-gray-400 hover:text-white"
              >
                Cancel
              </button>
              <button
                type="submit"
                class="px-4 py-2 bg-indigo-600 hover:bg-indigo-500 text-white rounded-lg"
              >
                Update Password
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
    <style>
      /* Custom scrollbar for code blocks */
      pre::-webkit-scrollbar {
        height: 8px;
      }
      pre::-webkit-scrollbar-track {
        background: #282c34;
        border-radius: 0 0 8px 8px;
      }
      pre::-webkit-scrollbar-thumb {
        background: #4b5563;
        border-radius: 4px;
      }
      pre::-webkit-scrollbar-thumb:hover {
        background: #6b7280;
      }

      /* Ensure code blocks have rounded corners and nice spacing in prose contexts */
      .prose pre {
        border-radius: 0.5rem !important;
        margin-top: 1.5rem !important;
        margin-bottom: 1.5rem !important;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1),
          0 2px 4px -1px rgba(0, 0, 0, 0.06);
        background-color: #282c34 !important; /* Match atom-one-dark */
        color: #abb2bf !important;
      }
    </style>
  </body>
</html>
