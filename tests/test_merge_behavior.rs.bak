use solidb::{parse, QueryExecutor, StorageEngine};
use serde_json::json;
use tempfile::TempDir;

#[test]
fn test_merge_nested_behavior() {
    let temp_dir = TempDir::new().expect("Failed to create temp dir");
    let storage = StorageEngine::new(temp_dir.path()).expect("Failed to create storage");

    storage.create_collection("test".to_string()).unwrap();
    let collection = storage.get_collection("test").unwrap();
    collection.insert(json!({"_key": "1"})).unwrap();

    // Test shallow merge - nested objects are replaced, not merged
    let query = parse(r#"
        FOR doc IN test
        LIMIT 1
        RETURN MERGE(
            {a: 1, nested: {x: 1, y: 2}},
            {b: 2, nested: {z: 3}}
        )
    "#).unwrap();

    let executor = QueryExecutor::new(&storage);
    let results = executor.execute(&query).unwrap();

    println!("Result: {}", serde_json::to_string_pretty(&results[0]).unwrap());

    // The nested object from the second argument completely replaces the first
    assert_eq!(results[0]["a"], json!(1.0));
    assert_eq!(results[0]["b"], json!(2.0));
    assert_eq!(results[0]["nested"]["z"], json!(3.0));
    // x and y are gone because nested was replaced, not merged
    assert_eq!(results[0]["nested"]["x"], json!(null));
    assert_eq!(results[0]["nested"]["y"], json!(null));
}
