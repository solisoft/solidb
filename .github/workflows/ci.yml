name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

env:
  CARGO_TERM_COLOR: always
  CARGO_INCREMENTAL: 0
  CARGO_PROFILE_DEV_DEBUG: 0

jobs:
  check-and-build:
    name: Check & Build
    if: |
      !(github.event_name == 'push' && (startsWith(github.event.head_commit.message, 'chore: release') || startsWith(github.event.head_commit.message, 'chore(main): release')))
    runs-on: ubuntu-latest
    env:
      RUSTFLAGS: "-C link-arg=-fuse-ld=lld"

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Free up disk space
        run: |
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /opt/ghc
          sudo rm -rf /usr/local/share/boost
          sudo rm -rf "$AGENT_TOOLSDIRECTORY"
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /opt/hostedtoolcache/CodeQL
          docker system prune -af || true

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            clang \
            lld \
            libclang-dev \
            pkg-config \
            libssl-dev \
            libzstd-dev \
            libsnappy-dev \
            liblz4-dev \
            zlib1g-dev \
            libbz2-dev \
            cmake \
            protobuf-compiler

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          components: clippy, rustfmt

      - name: Check formatting
        run: cargo fmt -- --check

      - name: Build
        run: cargo build --tests -j2 --verbose

      - name: Clean target before upload
        run: |
          rm -rf target/debug/incremental
          rm -rf target/debug/examples
          rm -rf target/debug/.fingerprint/solidb-*/invoked.timestamp
          find target/debug/deps -name '*.d' -delete
          find target/debug/build -name '*.o' -delete

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: cargo-target
          path: target/
          retention-days: 1

  clippy:
    name: Clippy
    runs-on: ubuntu-latest
    needs: check-and-build
    env:
      RUSTFLAGS: "-C link-arg=-fuse-ld=lld"

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Free up disk space
        run: |
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /opt/ghc
          sudo rm -rf /usr/local/share/boost
          sudo rm -rf "$AGENT_TOOLSDIRECTORY"
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /opt/hostedtoolcache/CodeQL
          docker system prune -af || true

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            clang \
            lld \
            libclang-dev \
            pkg-config \
            libssl-dev \
            libzstd-dev \
            libsnappy-dev \
            liblz4-dev \
            zlib1g-dev \
            libbz2-dev \
            cmake \
            protobuf-compiler

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          components: clippy

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: cargo-target
          path: target/

      - name: Run clippy
        run: cargo clippy -j2 -- -D warnings

  security:
    name: Security Audit
    runs-on: ubuntu-latest
    needs: clippy

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Free up disk space
        run: |
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /opt/ghc
          sudo rm -rf /usr/local/share/boost
          sudo rm -rf "$AGENT_TOOLSDIRECTORY"
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /opt/hostedtoolcache/CodeQL
          docker system prune -af || true

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Install cargo-audit
        run: cargo install cargo-audit

      - name: Run security audit
        run: cargo audit

  test:
    name: Test ${{ matrix.category }}
    runs-on: ubuntu-latest
    needs: security
    strategy:
      fail-fast: false
      matrix:
        category:
          - sdbql
          - storage
          - api
          - lua
          - cluster
          - other
        include:
          - category: sdbql
            pattern: "sdbql_"
          - category: storage
            pattern: "storage_"
          - category: api
            pattern: "api_"
          - category: lua
            pattern: "lua_"
          - category: cluster
            pattern: "cluster_"
          - category: other
            pattern: ""

    env:
      RUSTFLAGS: "-C link-arg=-fuse-ld=lld"

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Free up disk space
        run: |
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /opt/ghc
          sudo rm -rf /usr/local/share/boost
          sudo rm -rf "$AGENT_TOOLSDIRECTORY"
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /opt/hostedtoolcache/CodeQL
          docker system prune -af || true
          sudo apt-get clean

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            clang \
            lld \
            libclang-dev \
            pkg-config \
            libssl-dev \
            libzstd-dev \
            libsnappy-dev \
            liblz4-dev \
            zlib1g-dev \
            libbz2-dev \
            cmake \
            protobuf-compiler

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: cargo-target
          path: target/

      - name: Run ${{ matrix.category }} tests
        run: |
          if [ "${{ matrix.category }}" = "other" ]; then
            # Run all tests except those matching category patterns
            for test in tests/*.rs; do
              testname=$(basename "$test" .rs)
              # Skip tests that belong to other categories
              case "$testname" in
                sdbql_*|storage_*|api_*|lua_*|cluster_*) continue ;;
              esac
              echo "Running test: $testname"
              cargo test --test "$testname" -j2 || true
            done
          else
            # Find and run tests matching the pattern
            for test in tests/${{ matrix.pattern }}*; do
              if [ -f "$test" ]; then
                testname=$(basename "$test" .rs)
                echo "Running test: $testname"
                cargo test --test "$testname" -j2 || true
              fi
            done
          fi

  release-please:
    name: Release Please
    runs-on: ubuntu-latest
    needs: test
    if: |
      always() &&
      github.event_name == 'push' && github.ref == 'refs/heads/main' &&
      (needs.test.result == 'success' || needs.test.result == 'skipped')
    permissions:
      contents: write
      pull-requests: write

    steps:
      - uses: google-github-actions/release-please-action@v4
        id: release
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          config-file: release-please-config.json

    outputs:
      release_created: ${{ steps.release.outputs.release_created }}
      tag_name: ${{ steps.release.outputs.tag_name }}
      release_body: ${{ steps.release.outputs.release_body }}

  build-binaries:
    name: Build ${{ matrix.target }}
    runs-on: ${{ matrix.runner }}
    needs: release-please
    if: needs.release-please.outputs.release_created == 'true'
    strategy:
      matrix:
        include:
          - target: x86_64-unknown-linux-gnu
            runner: ubuntu-latest
            os: linux
            arch: amd64
          - target: aarch64-unknown-linux-gnu
            runner: ubuntu-24.04-arm
            os: linux
            arch: arm64
          - target: x86_64-apple-darwin
            runner: macos-13
            os: darwin
            arch: amd64
          - target: aarch64-apple-darwin
            runner: macos-14
            os: darwin
            arch: arm64
          - target: x86_64-pc-windows-msvc
            runner: windows-latest
            os: windows
            arch: amd64

    steps:
      - uses: actions/checkout@v4

      - name: Free up disk space (Linux)
        if: runner.os == 'Linux'
        run: |
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /opt/ghc
          sudo rm -rf /usr/local/share/boost
          sudo rm -rf "$AGENT_TOOLSDIRECTORY"
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /opt/hostedtoolcache/CodeQL
          docker system prune -af || true

      - name: Install system dependencies (Linux)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            clang \
            libclang-dev \
            pkg-config \
            libssl-dev \
            libzstd-dev \
            libsnappy-dev \
            liblz4-dev \
            zlib1g-dev \
            libbz2-dev \
            cmake \
            protobuf-compiler

      - name: Install system dependencies (macOS)
        if: runner.os == 'macOS'
        run: brew install zstd snappy lz4 protobuf cmake

      - name: Install system dependencies (Windows)
        if: runner.os == 'Windows'
        run: choco install llvm cmake protoc -y

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Build release binary
        run: cargo build --release --locked

      - name: Package binaries (Unix)
        if: runner.os != 'Windows'
        run: |
          mkdir -p dist
          cp target/release/solidb dist/
          cp target/release/solidb-dump dist/
          cp target/release/solidb-restore dist/
          tar czf solidb-${{ matrix.os }}-${{ matrix.arch }}.tar.gz -C dist .

      - name: Package binaries (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path dist
          Copy-Item target/release/solidb.exe dist/
          Copy-Item target/release/solidb-dump.exe dist/
          Copy-Item target/release/solidb-restore.exe dist/
          Compress-Archive -Path dist/* -DestinationPath solidb-${{ matrix.os }}-${{ matrix.arch }}.zip

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: solidb-${{ matrix.os }}-${{ matrix.arch }}
          path: solidb-${{ matrix.os }}-${{ matrix.arch }}.*

  docker:
    name: Docker
    runs-on: ubuntu-latest
    needs: release-please
    if: needs.release-please.outputs.release_created == 'true'
    permissions:
      contents: read
      packages: write

    steps:
      - uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Extract version
        id: version
        run: echo "version=${TAG#v}" >> "$GITHUB_OUTPUT"
        env:
          TAG: ${{ needs.release-please.outputs.tag_name }}

      - name: Build and push
        uses: docker/build-push-action@v6
        with:
          context: .
          platforms: linux/amd64,linux/arm64
          push: true
          tags: |
            solisoft/solidb:latest
            solisoft/solidb:${{ steps.version.outputs.version }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  release:
    name: Release
    runs-on: ubuntu-latest
    needs: [release-please, build-binaries]
    permissions:
      contents: write

    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts/

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            artifacts/**/*.tar.gz
            artifacts/**/*.zip
          tag_name: ${{ needs.release-please.outputs.tag_name }}
          body: ${{ needs.release-please.outputs.release_body }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    outputs:
      release_created: ${{ needs.release-please.outputs.release_created }}

  publish:
    name: Publish
    runs-on: ubuntu-latest
    needs: release
    if: always() && needs.release.result == 'success' && needs.release.outputs.release_created == 'true'
    environment: main

    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install system dependencies
        run: sudo apt-get update && sudo apt-get install -y libclang-dev libzstd-dev

      - name: Publish sdbql-core to crates.io
        run: cargo publish -p sdbql-core
        env:
          CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}

      - name: Wait for sdbql-core to be available
        run: |
          for i in $(seq 1 12); do
            if cargo search sdbql-core 2>/dev/null | grep -q "^sdbql-core = \"0"; then
              echo "sdbql-core is available on crates.io"
              break
            fi
            echo "Waiting for sdbql-core to appear in index (attempt $i/12)..."
            sleep 15
          done

      - name: Publish solidb-client to crates.io
        run: cargo publish -p solidb-client
        env:
          CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}

      - name: Wait for solidb-client to be available
        run: |
          for i in $(seq 1 12); do
            if cargo search solidb-client 2>/dev/null | grep -q "^solidb-client = \"0"; then
              echo "solidb-client is available on crates.io"
              break
            fi
            echo "Waiting for solidb-client to appear in index (attempt $i/12)..."
            sleep 15
          done

      - name: Publish solidb to crates.io
        run: cargo publish -p solidb --no-verify
        env:
          CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}
